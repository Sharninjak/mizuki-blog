#!/usr/bin/env node

/**
 * Mizuki 内容仓库初始化脚本
 * 帮助用户快速设置代码内容分离
 */

import { execSync } from "child_process";
import fs from "fs";
import path from "path";
import readline from "readline";
import { fileURLToPath } from "url";
import { loadEnv } from "./load-env.js";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const rootDir = path.resolve(__dirname, "..");

loadEnv();
console.log("Loaded .env configuration file\n");

const rl = readline.createInterface({
	input: process.stdin,
	output: process.stdout,
});

function question(query) {
	return new Promise((resolve) => rl.question(query, resolve));
}

function exec(command, options = {}) {
	try {
		return execSync(command, { stdio: "inherit", ...options });
	} catch (error) {
		console.error(`Command execution failed: ${command}`);
		throw error;
	}
}

function hasSeededContent(contentDir) {
	const markers = ["posts", "spec", "data", "images"];
	return markers.some((name) => fs.existsSync(path.join(contentDir, name)));
}

function copyRecursive(src, dest) {
	if (fs.statSync(src).isDirectory()) {
		if (!fs.existsSync(dest)) {
			fs.mkdirSync(dest, { recursive: true });
		}
		const entries = fs.readdirSync(src);
		for (const entry of entries) {
			copyRecursive(path.join(src, entry), path.join(dest, entry));
		}
	} else {
		fs.copyFileSync(src, dest);
	}
}

function seedContentRepository(contentDir) {
	const mappings = [
		{ src: "src/content/posts", dest: "posts" },
		{ src: "src/content/spec", dest: "spec" },
		{ src: "src/data", dest: "data" },
		{ src: "public/images", dest: "images" },
	];

	for (const mapping of mappings) {
		const srcPath = path.join(rootDir, mapping.src);
		const destPath = path.join(contentDir, mapping.dest);
		if (!fs.existsSync(srcPath)) {
			continue;
		}
		if (fs.existsSync(destPath)) {
			continue;
		}
		copyRecursive(srcPath, destPath);
	}
}

function ensureTriggerWorkflow(contentDir) {
	const workflowDir = path.join(contentDir, ".github", "workflows");
	const workflowPath = path.join(workflowDir, "trigger-build.yml");
	if (fs.existsSync(workflowPath)) {
		return;
	}
	fs.mkdirSync(workflowDir, { recursive: true });

	const workflowContent = `name: Trigger Mizuki build

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  dispatch:
    runs-on: ubuntu-latest
    steps:
      - name: Repository dispatch
        uses: peter-evans/repository-dispatch@v3
        with:
          token: \${{ secrets.DISPATCH_TOKEN }}
          repository: Sharninjak/mizuki-blog
          event-type: content-updated
`;

	fs.writeFileSync(workflowPath, workflowContent);
}

async function main() {
	console.log("Mizuki Content Repository Initialization\n");

	console.log("Using independent repository mode to manage content\n");

	// 询问内容仓库 URL
	const repoUrl = await question("Content repository URL: ");

	if (!repoUrl.trim()) {
		console.error("Error: Content repository URL cannot be empty!");
		rl.close();
		return;
	}

	// 确认信息
	console.log("\nConfiguration:");
	console.log("  Mode: Independent Repository");
	console.log(`  Repository: ${repoUrl.trim()}`);

	const confirm = await question("\nConfirm initialization? (y/n): ");

	if (confirm.toLowerCase() !== "y") {
		console.log("Initialization cancelled");
		rl.close();
		return;
	}

	console.log("\nStarting initialization...\n");

	// 创建 .env 文件
	const envPath = path.join(rootDir, ".env");
	const envContent = `# Mizuki Content Repository Configuration
# Auto-generated by initialization script

ENABLE_CONTENT_SYNC=true
CONTENT_REPO_URL=${repoUrl.trim()}
CONTENT_DIR=./content
USE_SUBMODULE=false

# Umami configuration (optional)
# UMAMI_API_KEY=your_api_key_here

# bcrypt configuration
BCRYPT_SALT_ROUNDS=12
`;

	fs.writeFileSync(envPath, envContent);
	console.log("Created .env file");

	// 同步内容
	console.log("Synchronizing content repository...");
	try {
		exec("pnpm run sync-content", {
			cwd: rootDir,
			env: {
				...process.env,
				ENABLE_CONTENT_SYNC: "true",
				CONTENT_REPO_URL: repoUrl.trim(),
				USE_SUBMODULE: "false",
			},
		});
		console.log("Content synchronized successfully");
	} catch (error) {
		console.error(
			"Content synchronization failed. Run manually: pnpm run sync-content",
		);
	}

	const contentDir = path.join(rootDir, "content");
	if (fs.existsSync(contentDir) && !hasSeededContent(contentDir)) {
		console.log("Seeding content repository from local content...");
		seedContentRepository(contentDir);
		console.log("Seed completed. Commit and push the content repository.");
	}
	if (fs.existsSync(contentDir)) {
		ensureTriggerWorkflow(contentDir);
		console.log("Created content repo trigger workflow template.");
		console.log("Remember to add DISPATCH_TOKEN in the content repo secrets.");
	}

	// 提示后续步骤
	console.log("\nInitialization completed\n");
	console.log("\nDocumentation:");
	console.log("- Content repository: docs/CONTENT_REPOSITORY.md");
	console.log("- Migration guide: docs/MIGRATION_GUIDE.md");

	rl.close();
}

main().catch((error) => {
	console.error("Initialization failed:", error);
	rl.close();
	process.exit(1);
});
